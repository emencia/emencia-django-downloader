{% extends "downloader/base.html" %}
{% load i18n %}
{% load downloadertags %}

{% block header %}
{% endblock %}
{% block css %}
    <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}/css/fileuploader.css">
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
{% endblock %}
{% block content %}
<div>
    <form id="upload_form" action="{% url upload %}" method="post" accept-charset="utf-8" class="steps">
        
        <div id="file-uploader">
            <noscript>
                <p>Please enable JavaScript to use file uploader.</p>
            </noscript>
        </div>
        {% if form.file_id.errors %}
            <p class="error field_error">{{ form.file_id.errors|join:"<br />" }}</p>
        {% endif %}
        <input type="hidden" id="id_file_id" name="file_id" value=""/>

        {% display_field form.my_mail %}
        {% display_field form.notify1 %}
        {% display_field form.notify2 %}
        {% display_field form.notify3 %}
        {% display_field form.comment %}
        {% display_field form.password %}

        <p>
            <span class="step"></span>
            <input type="submit" value="Upload"/>
        </p>
        {% csrf_token %}

    </form>
</div>

<div id="progress_container">
    <div id="progress_filename"></div>
    <div id="progress_bar">
        <div id="progress_indicator"></div>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}/js/jquery.tablesorter.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}/js/fileuploader.js"></script>
    
<script type="text/javascript" charset="utf-8">
//<![CDATA[
var fileSizePattern = /^(\d+(?:\.\d+)*)\s*([egkmpt])b?$/i;
$.tablesorter.addParser({
    id: 'filesize',
    is: function(s) {
        return fileSizePattern.test(s);
    },
    format: function(s) {
        var groups = fileSizePattern.exec(s);
        if (groups != null)
        {
            var size = new Number(groups[1]);
            var unit = groups[2].toLowerCase();
            switch (unit) {
                case 'k':
                    return size * 1024;
                case 'm':
                    return size * Math.pow(1024, 2);
                case 'g':
                    return size * Math.pow(1024, 3);
                case 't':
                    return size * Math.pow(1024, 4);
                case 'p':
                    return size * Math.pow(1024, 5);
                case 'e':
                    return size * Math.pow(1024, 6);
                return size;
            }
        }
    },
    type: 'numeric'
});

$(document).ready(function() {
        $("#progress_bar").progressbar();

        var uploader = new qq.FileUploader( {
            action: "{% url ajax_upload %}",
            element: $('#file-uploader')[0],
            multiple: false,
            sizeLimit: {{ MAX_FILE_UPLOAD_SIZE }},
            onComplete: function( id, fileName, responseJSON ) {
                if( responseJSON.success ) {
                    $("#id_file_id").val(responseJSON.file_id);
                    $("#progress_bar").hide('slow');
                }
                //TODO Error handling
            },
            onProgress: function(id, fileName, loaded, total){
                var percentage = Math.floor(100 * loaded/total);
                $("#progress_bar").progressbar({value: percentage});
            },
            onSubmit: function(id, fileName){
                $("#progress_bar").show();
            },
            onCancel: function(id, fileName){
                $("#progress_bar").hide();
            },
        // messages
            params: {
              'csrf_token': '{{ csrf_token }}',
              'csrf_name': 'csrfmiddlewaretoken',
              'csrf_xname': 'X-CSRFToken',
            },
          });
    });
//]]>
</script>
{% endblock %}

