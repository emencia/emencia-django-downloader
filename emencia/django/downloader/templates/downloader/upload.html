{% extends "downloader/base.html" %}
{% load i18n %}
{% load downloadertags %}

{% block header %}
{% endblock %}
{% block css %}
    <link rel="stylesheet" type="text/css" media="screen" href="{{ STATIC_URL }}/fileuploader.css">
{% endblock %}
{% block content %}
<div>
    <form id="upload_form" action="{% url upload %}" method="post" accept-charset="utf-8" class="steps">
        
        <div id="file-uploader">
            <noscript>
                <p>Please enable JavaScript to use file uploader.</p>
            </noscript>
        </div>

        {% display_field form.file_id %}
        {% display_field form.my_mail %}
        {% display_field form.notify1 %}
        {% display_field form.notify2 %}
        {% display_field form.notify3 %}
        {% display_field form.comment %}
        {% display_field form.password %}

        <p>
            <span class="step"></span>
            <input type="submit" value="Upload"/>
        </p>
        {% csrf_token %}

    </form>
</div>

<!--
<div id="progress_container">
    <div id="progress_filename"></div>
    <div id="progress_bar">
        <div id="progress_indicator"></div>
    </div>
</div>
-->

{% endblock %}

{% block javascript %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}jquery.tablesorter.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}fileuploader.js"></script>
    
<script type="text/javascript" charset="utf-8">
//<![CDATA[
var fileSizePattern = /^(\d+(?:\.\d+)*)\s*([egkmpt])b?$/i;
$.tablesorter.addParser({
    id: 'filesize',
    is: function(s) {
        return fileSizePattern.test(s);
    },
    format: function(s) {
        var groups = fileSizePattern.exec(s);
        if (groups != null)
        {
            var size = new Number(groups[1]);
            var unit = groups[2].toLowerCase();
            switch (unit) {
                case 'k':
                    return size * 1024;
                case 'm':
                    return size * Math.pow(1024, 2);
                case 'g':
                    return size * Math.pow(1024, 3);
                case 't':
                    return size * Math.pow(1024, 4);
                case 'p':
                    return size * Math.pow(1024, 5);
                case 'e':
                    return size * Math.pow(1024, 6);
                return size;
            }
        }
    },
    type: 'numeric'
});

$(document).ready(function()
    {
        $("#upload_table").tablesorter({
            cssHeader: 'sortable',
            cssAsc: 'sortedAsc',
            cssDesc: 'sortedDesc',
            widgets: ['zebra'],
            headers: {3: {sorter: false}}
        });

        var uploader = new qq.FileUploader( {
            action: "{% url ajax_upload %}",
            element: $('#file-uploader')[0],
            multiple: true,
            onComplete: function( id, fileName, responseJSON ) {
              if( responseJSON.success )
                $("#id_file_id").val(responseJSON.file_id);
              else
                alert("upload failed!");
            },
            onAllComplete: function( uploads ) {
              // uploads is an array of maps
              // the maps look like this: { file: FileObject, response: JSONServerResponse }
              alert( "All complete!" ) ;
            },
            params: {
              'csrf_token': '{{ csrf_token }}',
              'csrf_name': 'csrfmiddlewaretoken',
              'csrf_xname': 'X-CSRFToken',
            },
          });
    });
//]]>
</script>
{% endblock %}

